# ============================================
# Insider Risk Monitor - Docker Compose
# ============================================
# Services:
#   - web: Next.js application (dashboard + API)
#   - worker: Background job processor
#   - redis: Rate limiting cache
#   - migrate: Database migrations (runs once)
# ============================================
# Usage:
#   docker compose up              # Start all services
#   docker compose up -d           # Start in detached mode
#   docker compose down            # Stop all services
#   docker compose logs -f web     # Follow web logs
#   docker compose logs -f worker  # Follow worker logs
# ============================================

services:
  # ============================================
  # Web Service - Next.js Application (~150MB)
  # ============================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    container_name: insider-risk-web
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_URL=http://localhost:3000
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - ADMIN_NAME=${ADMIN_NAME:-Admin User}
      - REDIS_URL=redis://redis:6379
      - DATA_RETENTION_DAYS=${DATA_RETENTION_DAYS:-90}
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - insider-risk-network

  # ============================================
  # Worker Service - Background Jobs (~200MB)
  # ============================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: worker
    container_name: insider-risk-worker
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      - BASELINE_INTERVAL_MS=${BASELINE_INTERVAL_MS:-300000}
      - SCORING_INTERVAL_MS=${SCORING_INTERVAL_MS:-300000}
      - RETENTION_INTERVAL_MS=${RETENTION_INTERVAL_MS:-86400000}
      - ALERT_THRESHOLD=${ALERT_THRESHOLD:-60}
      - SCORING_WINDOW_MINUTES=${SCORING_WINDOW_MINUTES:-60}
      - DEFAULT_RETENTION_DAYS=${DATA_RETENTION_DAYS:-90}
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - insider-risk-network

  # ============================================
  # Redis Service - Rate Limiting Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: insider-risk-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - insider-risk-network

  # ============================================
  # Database Migration Service (runs once)
  # ============================================
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      target: migrate
    container_name: insider-risk-migrate
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-change-this-password}
      - ADMIN_NAME=${ADMIN_NAME:-Admin User}
    depends_on:
      redis:
        condition: service_healthy
    restart: "no"
    networks:
      - insider-risk-network

networks:
  insider-risk-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
